<!--
Documentation and licence at https://github.com/liwenyip/hugo-easy-gallery/
-->
<!--
@-REC: Modified version (see README for details):
* Added input parameters: "static".
* Handles page parameters: "images_copyright" and "images".
-->
{{- $page := $.Page -}}
<!-- count how many times we've called this shortcode; load the css if it's the first time -->
{{- if not ($page.Scratch.Get "figurecount") }}<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />{{ end }}
{{- $page.Scratch.Add "figurecount" 1 }}
{{ $baseURL := $page.Site.BaseURL }}
{{- $images_copyright := $page.Params.images_copyright -}}
{{- $images_params := $page.Params.images -}}
{{- $static := .Get "static" | default "false" -}}
<div class="gallery caption-position-{{ with .Get "caption-position" | default "bottom" }}{{.}}{{end}} caption-effect-{{ with .Get "caption-effect" | default "slide" }}{{.}}{{end}} hover-effect-{{ with .Get "hover-effect" | default "zoom" }}{{.}}{{end}} {{ if ne (.Get "hover-transition") "none" }}hover-transition{{end}}" itemscope itemtype="http://schema.org/ImageGallery">
	{{- with .Get "dir" -}}
		<!-- If a directory was specified, generate figures for all of the images in the directory -->
		{{- if eq $static "true" -}}
            {{- $page.Scratch.Set "dirURL" (print .) -}}
            {{- $page.Scratch.Set "dirFiles" (print "/static/" .) -}}
		{{- else -}}
			{{- $tmpDir := print (replace $page.File.Dir  "\\" "/") "/" . -}}
            {{- $page.Scratch.Set "dirURL" $tmpDir -}}
            {{- $page.Scratch.Set "dirFiles" (print "/content/" $tmpDir "/") -}}
		{{- end -}}
		{{- $dir := $page.Scratch.Get "dirURL" -}}
		{{- $dirFiles := $page.Scratch.Get "dirFiles" -}}
		{{- if (fileExists $dirFiles) -}}
			{{- $files := readDir $dirFiles -}}
			{{- range $files -}}
				<!-- skip files that aren't images, or that inlcude the thumb suffix in their name -->
				{{- $thumbext := $.Get "thumb" | default "-thumb" }}
				{{- $isthumb := .Name | findRE ($thumbext | printf "%s\\.") }}<!-- is the current file a thumbnail image? -->
				{{- $isimg := lower .Name | findRE "\\.(gif|jpg|jpeg|tiff|png|bmp)" }}<!-- is the current file an image? -->
				{{- if and $isimg (not $isthumb) }}
					{{- $name := .Name -}}
					{{- with $images_copyright -}}
						{{- $page.Scratch.Set "copyright" (print " - &copy; " .) -}}
					{{- end -}}
					{{- range $images_params -}}
						{{- if eq .src $name -}}
							{{- with .title -}}
								{{- $page.Scratch.Set "title" . -}}
							{{- end -}}
							{{- with .copyright -}}
								{{- $page.Scratch.Set "copyright" (print " - &copy; " .) -}}
							{{- end -}}
						{{- end -}}
					{{- end -}}

					{{- $title := ($page.Scratch.Get "title") | default (.Name | replaceRE "\\..*" "") }}
					{{- $copyright := ($page.Scratch.Get "copyright") | default "" }}

					{{- $captionthumb :=  $title }}
					{{- $caption :=  (print $title $copyright) }}

					{{- $linkURL := print $baseURL $dir "/" .Name | absURL }}<!-- absolute URL to hi-res image -->
					{{- $thumb := .Name | replaceRE "(\\.)" ($thumbext | printf "%s.") }}<!-- filename of thumbnail image -->
					{{- $thumbexists := where $files "Name" $thumb }}<!-- does a thumbnail image exist? --> 
					{{- $thumbURL := print $baseURL $dir "/" $thumb | absURL }}<!-- absolute URL to thumbnail image -->
					<div class="box">
					<figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
						<div class="img" style="background-image: url('{{ if $thumbexists }}{{ $thumbURL }}{{ else }}{{ $linkURL }}{{ end }}');" >
							<img itemprop="thumbnail" src="{{ if $thumbexists }}{{ $thumbURL }}{{ else }}{{ $linkURL }}{{ end }}" alt="{{ $caption }}" /><!-- <img> hidden if in .gallery -->
						</div>
					<figcaption>
					<p>{{ $captionthumb }}</p>
					</figcaption>
						<a href="{{ $linkURL }}" itemprop="contentUrl"></a><!-- put <a> last so it is stacked on top -->
					</figure>
					</div>
					{{- $page.Scratch.Delete "title" -}}
					{{- $page.Scratch.Delete "copyright" -}}
				{{- end }}
			{{- end }}
		{{- end -}}
		{{- $page.Scratch.Delete "dirURL" -}}
		{{- $page.Scratch.Delete "dirFiles" -}}
	{{- else -}}
		<!-- If no directory was specified, include any figure shortcodes called within the gallery -->
{{/* TODO: handle "static", "copyright", etc. (additionally to figure level) */}}
	  {{ .Inner }}
	{{- end }}
</div>
